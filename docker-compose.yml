version: '3.8'

services:
  ibgateway:
    image: ghcr.io/unusualalpha/ibgateway:latest
    container_name: ibgateway
    environment:
      - TWS_USERID=${TWS_USERID}
      - TWS_PASSWORD=${TWS_PASSWORD}
      - TRADING_MODE=paper
      - VNC_PASSWORD=secret
    ports:
      - "4001:4001"  # IB API
      - "5900:5900"  # VNC (optional)
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  kdb:
    image: kxsys/kdb:latest
    container_name: kdb-tick
    ports:
      - "5000:5000"
    volumes:
      - ./kdb:/opt/kdb
      - kdb-data:/var/q
    command: q /opt/kdb/tick.q -p 5000

  feeder:
    build: ./feeder
    container_name: nifty-feeder
    depends_on:
      ibgateway:
        condition: service_healthy
      kdb:
        condition: service_started
    environment:
      - IB_HOST=ibgateway
      - IB_PORT=4001
      - KDB_HOST=kdb-tick
      - KDB_PORT=5000
      - CLIENT_ID=10
    volumes:
      - ./feeder:/app

volumes:
  kdb-data: