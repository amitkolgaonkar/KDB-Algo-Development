version: '3.8'
services:
  tick:  # Tickerplant (TP)
    build:
      context: ./q
      dockerfile: Dockerfile
    container_name: tick
    command: 
      - "/root/q/l64/q"      # Binary
      - "tick.q"             # Script
      - "-p"                 # Flag
      - "5010"               # Port
    volumes:
      - ./tmp:/tmp
      - ./q/kc.lic:/root/q/kc.lic:ro
    environment:
      - FEED_INTERVAL=1000
    restart: always  # Add for resilience
    expose:          # Add for internal networking
      - 5010

  rdb:
    build:
      context: ./q
      dockerfile: Dockerfile
    container_name: rdb
    command:
      - "/root/q/l64/q"
      - "r.q"
      - "-p"
      - "5011"
    depends_on:
      - tick
    volumes:
      - ./hdb:/hdb
      - ./q/kc.lic:/root/q/kc.lic:ro
    environment:
      - FEED_INTERVAL=1000
    restart: always
    expose:
      - 5011

  testfeed:
    build:
      context: ./q
      dockerfile: Dockerfile
    container_name: testfeed
    command:
      - "/root/q/l64/q"
      - "testfeed.q"
    depends_on:
      - tick
    volumes:
      - ./q/kc.lic:/root/q/kc.lic:ro
    environment:
      - FEED_INTERVAL=2000
    restart: always

  # Python Services (unchanged - good as-is)
  collector:
    build:
      context: .
      dockerfile: collector/Dockerfile
    container_name: collector
    working_dir: /app
    command: ["python", "collector_ibkr.py"]
    depends_on:
      - tick
    environment:
      - KDB_HOST=tick
      - KDB_PORT=5010  # Fixed: Was 5001 → 5010 (TP port)
    volumes:
      - ./collector/collector_ibkr.py:/app/collector_ibkr.py
      - ./config.yaml:/app/config.yaml
      - ./utils:/app/utils
    restart: always

  strategy:
    build:
      context: .
      dockerfile: strategy/Dockerfile
    container_name: strategy
    working_dir: /app
    command: ["python", "strategy_engine.py"]
    depends_on:
      - rdb
    environment:
      - KDB_HOST=rdb
      - KDB_PORT=5011  # Fixed: Was 5010 → 5011 (RDB port)
    volumes:
      - ./strategy:/app
      - ./utils:/app/utils
    restart: always

  execution:
    build:
      context: .
      dockerfile: execution/Dockerfile
    container_name: execution
    working_dir: /app
    command: ["python", "execution_engine.py"]
    depends_on:
      - strategy
    volumes:
      - ./execution:/app
      - ./utils:/app/utils
    restart: always

  monitor:
    build:
      context: .
      dockerfile: monitor/Dockerfile
    container_name: monitor
    working_dir: /app
    command: ["python", "monitor.py"]
    depends_on:
      - execution
    volumes:
      - ./monitor:/app
      - ./utils:/app/utils
    restart: always

# Remove unused volumes:db (or assign to a service)