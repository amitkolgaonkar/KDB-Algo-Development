services:
  tick:
    image: ubuntu:22.04
    container_name: tick
    working_dir: /opt/kdb
    volumes:
      - ./kdb/common:/opt/kdb
    command: ["/opt/kdb/q", "/opt/kdb/tick.q", "-p", "5000"]
    environment:
      - QHOME=/opt/kdb
      - QLIC=/opt/kdb
    ports:
      - "5000:5000"
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"

  rdb:
    image: ubuntu:22.04
    container_name: kdb-rdb
    working_dir: /opt/kdb
    volumes:
      - ./kdb/common:/opt/kdb
    depends_on:
      - tick
    command: ["/opt/kdb/q", "/opt/kdb/rdb.q", "-p", "5010"]
    environment:
      - QHOME=/opt/kdb
      - QLIC=/opt/kdb
    ports:
      - "5010:5010"
    restart: unless-stopped

  signal:
    image: ubuntu:22.04
    container_name: kdb-signal
    working_dir: /opt/kdb
    volumes:
      - ./kdb/common:/opt/kdb
    depends_on:
      - tick
      - rdb
    command: ["/opt/kdb/q", "/opt/kdb/signal.q", "-p", "6000"]
    environment:
      - QHOME=/opt/kdb
      - QLIC=/opt/kdb
    ports:
      - "6000:6000"
    restart: unless-stopped

  strategy:
    image: ubuntu:22.04
    container_name: kdb-strategy
    working_dir: /opt/kdb
    volumes:
      - ./kdb/common:/opt/kdb
    depends_on:
      - tick
      - rdb
      - signal
    command: ["/opt/kdb/q", "/opt/kdb/strategy.q", "-p", "7000"]
    environment:
      - QHOME=/opt/kdb
      - QLIC=/opt/kdb
    ports:
      - "7000:7000"
    restart: unless-stopped

  feeder:
    build: ./feeder
    container_name: ibkr-feeder
    working_dir: /app
    environment:
      - FEED_MODE=${FEED_MODE:-ibkr}         # set to "ibkr" for real TWS use
      - IB_HOST=${IB_HOST:-host.docker.internal}
      - IB_PORT=${IB_PORT:-4001}
      - IB_CLIENT_ID=${IB_CLIENT_ID:-10}
      - KDB_HOST=tick
      - KDB_PORT=5000
    depends_on:
      - tick
    volumes:
      - ./feeder:/app
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"